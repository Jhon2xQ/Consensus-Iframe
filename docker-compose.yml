version: "3.1"

services:
  fastify-app:
    build: .
    container_name: fastify-key-management
    environment:
      # Credenciales para que el SDK de la App maneje el Share 2
      - HOT_PROJECT_ID=${HOT_PROJECT_ID}
      - HOT_CLIENT_ID=${HOT_CLIENT_ID}
      - HOT_CLIENT_SECRET=${HOT_CLIENT_SECRET}

      # Credenciales para que el SDK de la App maneje el Share 3
      - COLD_PROJECT_ID=${COLD_PROJECT_ID}
      - COLD_CLIENT_ID=${COLD_CLIENT_ID}
      - COLD_CLIENT_SECRET=${COLD_CLIENT_SECRET}

      # Ruta del JSON generado por el Agente (Configuración general)
      - SECRETS_PATH=/app/secrets/config.json
      - INFISICAL_ENV=${INFISICAL_ENV}
    volumes:
      - "infisical-config-vol:/app/secrets:ro"
    depends_on:
      - config-agent

  config-agent:
    image: "infisical/cli:0.18.0"
    container_name: infisical-agent-config
    environment:
      # Asegúrate de que estas variables estén en tu .env
      - INFISICAL_CLIENT_ID=${AGENT_CLIENT_ID}
      - INFISICAL_CLIENT_SECRET=${AGENT_CLIENT_SECRET}
      - INFISICAL_PROJECT_ID=${AGENT_PROJECT_ID}
      - INFISICAL_ENV=${INFISICAL_ENV:-dev}
    volumes:
      - "infisical-config-vol:/app-secrets"
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        # 1. Crear directorio
        mkdir -p /etc/infisical

        # 2. GUARDAR CREDENCIALES USANDO PRINTF (Sin saltos de línea)
        # Esto es vital para evitar el error 401
        printf "%s" "$INFISICAL_CLIENT_ID" > /etc/infisical/client-id
        printf "%s" "$INFISICAL_CLIENT_SECRET" > /etc/infisical/client-secret

        # 3. Crear la plantilla JSON con la sintaxis exacta de tu ejemplo funcional
        # Usamos comillas simples alrededor de las variables dentro del template
        echo '{
          {{- with secret "'$INFISICAL_PROJECT_ID'" "'$INFISICAL_ENV'" "/" -}}
          {{- range $index, $secret := . -}}
          {{- if $index }},{{ end }}
          "{{ $secret.Key }}": "{{ $secret.Value }}"
          {{- end -}}
          {{- end -}}
        }' > /etc/infisical/json.tmpl

        # 4. Crear configuración del agente
        echo "infisical:
          address: 'https://app.infisical.com'
        auth:
          type: 'universal-auth'
          config:
            client-id: '/etc/infisical/client-id'
            client-secret: '/etc/infisical/client-secret'
            remove_client_secret_on_read: false
        sinks:
          - type: 'file'
            config:
              path: '/app-secrets/access-token'
        templates:
          - source-path: '/etc/infisical/json.tmpl'
            destination-path: '/app-secrets/config.json'
            config:
              polling-interval: 60s" > /etc/infisical/config.yaml

        echo "Iniciando Infisical Agent corregido..."
        infisical agent --config=/etc/infisical/config.yaml

volumes:
  infisical-config-vol:
