version: "3.1"

services:
  # Servicio de la aplicación Fastify
  fastify-app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fastify-key-management
    environment:
      - NODE_ENV=production
      - SECRETS_PATH=${SECRETS_PATH:-/app/secrets/secrets.json}
      # Variables para Hot Storage (SDK usado en /create-shares y /recovery)
      - INFISICAL_HOT_PROJECT_ID=${INFISICAL_PROJECT_ID}
      - INFISICAL_HOT_CLIENT_ID=${INFISICAL_CLIENT_ID}
      - INFISICAL_HOT_CLIENT_SECRET=${INFISICAL_CLIENT_SECRET}
      # Variables para Cold Storage (SDK usado en todos los endpoints)
      - INFISICAL_COLD_PROJECT_ID=${INFISICAL_COLD_PROJECT_ID}
      - INFISICAL_COLD_CLIENT_ID=${INFISICAL_COLD_CLIENT_ID}
      - INFISICAL_COLD_CLIENT_SECRET=${INFISICAL_COLD_CLIENT_SECRET}
      - INFISICAL_ENVIRONMENT=${INFISICAL_ENV:-dev}
    ports:
      - "3000:3000"
    volumes:
      - infisical-secrets:/app/secrets:ro # Montaje en modo solo lectura
    networks:
      - infisical-network
    depends_on:
      - infisical-agent
    restart: unless-stopped

  # Agente de Infisical para Hot Storage
  infisical-agent:
    image: infisical/cli:0.18.0
    container_name: infisical-agent-hot
    environment:
      - INFISICAL_CLIENT_ID=${INFISICAL_CLIENT_ID}
      - INFISICAL_CLIENT_SECRET=${INFISICAL_CLIENT_SECRET}
      - INFISICAL_PROJECT_ID=${INFISICAL_PROJECT_ID}
      - INFISICAL_ENV=${INFISICAL_ENV:-dev}
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        # 1. Crear directorios
        mkdir -p /etc/infisical

        # 2. Crear la plantilla JSON (Usando un heredoc para evitar errores de comillas)
        # Usamos 'EOF' entre comillas para que el shell NO intente expandir nada dentro
        cat << 'EOF' > /etc/infisical/json.tmpl
        {
          {{- with secret "[[PROJECT_ID]]" "[[ENV]]" "/" }}
          {{- range $index, $secret := . }}
          {{- if $index }},{{ end }}
          "{{ $secret.Key }}": "{{ $secret.Value }}"
          {{- end }}
          {{- end }}
        }
        EOF

        # 3. Reemplazar los placeholders por las variables de entorno reales en la plantilla
        sed -i "s/\[\[PROJECT_ID\]\]/$INFISICAL_PROJECT_ID/g" /etc/infisical/json.tmpl
        sed -i "s/\[\[ENV\]\]/$INFISICAL_ENV/g" /etc/infisical/json.tmpl

        # 4. Crear archivo de configuración del agente
        echo "
        infisical:
          address: 'https://app.infisical.com'
        auth:
          type: 'universal-auth'
          config:
            client-id: '$INFISICAL_CLIENT_ID'
            client-secret: '$INFISICAL_CLIENT_SECRET'
            remove_client_secret_on_read: false
        sinks:
          - type: 'file'
            config:
              path: '/app-secrets/access-token'
        templates:
          - source-path: '/etc/infisical/json.tmpl'
            destination-path: '/app-secrets/secrets.json'
            config:
              polling-interval: 60s
        " > /etc/infisical/config.yaml

        echo "Iniciando Infisical Agent..."
        infisical agent --config=/etc/infisical/config.yaml
    volumes:
      - infisical-secrets:/app-secrets
    networks:
      - infisical-network
    restart: always

volumes:
  infisical-secrets:
    name: infisical-secrets

networks:
  infisical-network:
    name: infisical-network
    driver: bridge
