version: "3.8"

services:
  # --- AGENTE DE INFISICAL ---
  config-agent:
    image: "infisical/cli:0.18.0"
    container_name: infisical-agent-config
    # Sobrescribimos el entrypoint para poder usar comandos de shell
    entrypoint: ["/bin/sh", "-c"]
    environment:
      - AGENT_CLIENT_ID=${AGENT_CLIENT_ID}
      - AGENT_CLIENT_SECRET=${AGENT_CLIENT_SECRET}
      - AGENT_PROJECT_ID=${AGENT_PROJECT_ID}
      - INFISICAL_ENV=${INFISICAL_ENV:-dev}
    volumes:
      - "infisical-config-vol:/app-secrets"
    command:
      - |
        mkdir -p /app/auth /app/config

        # 1. Crear archivos de credenciales
        echo "$$AGENT_CLIENT_ID" > /app/auth/client-id
        echo "$$AGENT_CLIENT_SECRET" > /app/auth/client-secret

        # 2. Crear el Template para generar un JSON válido
        echo '{{- with secret "'$$AGENT_PROJECT_ID'" "'$$INFISICAL_ENV'" "/" -}}
        {
          {{- range $index, $pair := . -}}
            {{- if $index -}},{{- end }}
            "{{ $pair.Key }}": "{{ $pair.Value }}"
          {{- end }}
        }
        {{- end -}}' > /app/config/json-template.tmpl

        # 3. Crear la configuración del agente
        echo 'infisical:
          address: "https://app.infisical.com"
        auth:
          type: "universal-auth"
          config:
            client-id: "/app/auth/client-id"
            client-secret: "/app/auth/client-secret"
            remove_client_secret_on_read: false
        sinks:
          - type: "file"
            config:
              path: "/app-secrets/.access-token"
        templates:
          - source-path: "/app/config/json-template.tmpl"
            destination-path: "/app-secrets/config.json"
            config:
              polling-interval: 60s' > /app/config/agent-config.yaml

        # 4. Ejecutar el agente (llamando al binario directamente)
        infisical agent --config=/app/config/agent-config.yaml

  # --- TU APLICACIÓN FASTIFY ---
  fastify-app:
    build: .
    container_name: fastify-key-management
    # También sobrescribimos entrypoint aquí para asegurar la espera del archivo
    entrypoint: ["/bin/sh", "-c"]
    environment:
      - HOT_PROJECT_ID=${HOT_PROJECT_ID}
      - HOT_CLIENT_ID=${HOT_CLIENT_ID}
      - HOT_CLIENT_SECRET=${HOT_CLIENT_SECRET}
      - COLD_PROJECT_ID=${COLD_PROJECT_ID}
      - COLD_CLIENT_ID=${COLD_CLIENT_ID}
      - COLD_CLIENT_SECRET=${COLD_CLIENT_SECRET}
      - SECRETS_PATH=/app/secrets/config.json
      - INFISICAL_ENV=${INFISICAL_ENV}
    volumes:
      - "infisical-config-vol:/app/secrets:ro"
    depends_on:
      - config-agent
    command:
      - |
        echo "Esperando a que el agente genere config.json..."
        until [ -f /app/secrets/config.json ]; do
          sleep 2
        done
        echo "Archivo config.json encontrado. Iniciando aplicación..."
        npm start

volumes:
  infisical-config-vol:
